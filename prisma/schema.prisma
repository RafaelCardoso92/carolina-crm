generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cliente {
  id                 String              @id @default(cuid())
  nome               String
  codigo             String?             @unique
  telefone           String?
  email              String?
  morada             String?
  notas              String?
  ativo              Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  ultimoContacto     DateTime?
  cidade             String?
  codigoPostal       String?
  latitude           Float?
  longitude          Float?
  amostras           Amostra[]
  insights           ClienteInsight[]
  segmento           ClienteSegmento?
  cobrancas          Cobranca[]
  comunicacoes       Comunicacao[]
  itensReconciliacao ItemReconciliacao[]
  orcamentos         Orcamento[]
  tarefas            Tarefa[]
  vendas             Venda[]
  acordoParceria     AcordoParceria?
}

model Venda {
  id                 String              @id @default(cuid())
  clienteId          String
  valor1             Decimal?            @db.Decimal(10, 2)
  valor2             Decimal?            @db.Decimal(10, 2)
  total              Decimal             @db.Decimal(10, 2)
  mes                Int
  ano                Int
  notas              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  CampanhaVenda      CampanhaVenda[]
  Cobranca           Cobranca?
  devolucoes         Devolucao[]
  itensReconciliacao ItemReconciliacao[]
  itens              ItemVenda[]
  cliente            Cliente             @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@index([mes, ano])
}

model Cobranca {
  id                   String    @id @default(cuid())
  clienteId            String
  fatura               String?
  valor                Decimal   @db.Decimal(10, 2)
  valorSemIva          Decimal?  @db.Decimal(10, 2)
  comissao             Decimal?  @db.Decimal(10, 2)
  dataEmissao          DateTime?
  dataPago             DateTime?
  pago                 Boolean   @default(false)
  notas                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  dataInicioVencimento DateTime?
  numeroParcelas       Int       @default(1)
  vendaId              String?   @unique
  cliente              Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  Venda                Venda?    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  parcelas             Parcela[]

  @@index([clienteId])
  @@index([pago])
}

model Parcela {
  id             String    @id @default(cuid())
  cobrancaId     String
  numero         Int
  valor          Decimal   @db.Decimal(10, 2)
  dataVencimento DateTime
  dataPago       DateTime?
  pago           Boolean   @default(false)
  notas          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  cobranca       Cobranca  @relation(fields: [cobrancaId], references: [id], onDelete: Cascade)

  @@unique([cobrancaId, numero])
  @@index([cobrancaId])
  @@index([dataVencimento])
  @@index([pago])
}

model ObjetivoMensal {
  id        String   @id @default(cuid())
  mes       Int
  ano       Int
  objetivo  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mes, ano])
}

model ObjetivoTrimestral {
  id        String   @id @default(cuid())
  trimestre Int
  ano       Int
  objetivo  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([trimestre, ano])
}

model ObjetivoAnual {
  id        String   @id @default(cuid())
  ano       Int      @unique
  objetivo  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Configuracao {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PremioMensal {
  id        String   @id @default(cuid())
  minimo    Decimal  @unique @db.Decimal(10, 2)
  premio    Decimal  @db.Decimal(10, 2)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PremioTrimestral {
  id        String   @id @default(cuid())
  minimo    Decimal  @unique @db.Decimal(10, 2)
  premio    Decimal  @db.Decimal(10, 2)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PremioAnual {
  id        String   @id @default(cuid())
  minimo    Decimal  @unique @db.Decimal(10, 2)
  premio    Decimal  @db.Decimal(10, 2)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Produto {
  id              String            @id @default(cuid())
  nome            String
  codigo          String?           @unique
  categoria       String?
  descricao       String?
  ativo           Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  preco           Decimal?          @db.Decimal(10, 2)
  tipo            String?
  amostras        Amostra[]
  CampanhaProduto CampanhaProduto[]
  substituicoes   ItemDevolucao[]   @relation("Substituicao")
  itensOrcamento  ItemOrcamento[]
  itensVenda      ItemVenda[]
}

model ItemVenda {
  id         String          @id @default(cuid())
  vendaId    String
  produtoId  String
  quantidade Decimal         @db.Decimal(10, 2)
  precoUnit  Decimal         @db.Decimal(10, 2)
  subtotal   Decimal         @db.Decimal(10, 2)
  createdAt  DateTime        @default(now())
  devolucoes ItemDevolucao[]
  produto    Produto         @relation(fields: [produtoId], references: [id])
  venda      Venda           @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  @@index([vendaId])
  @@index([produtoId])
}

model Prospecto {
  id                 String            @id @default(cuid())
  nomeEmpresa        String
  tipoNegocio        String?
  website            String?
  facebook           String?
  instagram          String?
  nomeContacto       String?
  cargoContacto      String?
  telefone           String?
  email              String?
  morada             String?
  cidade             String?
  codigoPostal       String?
  latitude           Float?
  longitude          Float?
  estado             EstadoPipeline    @default(NOVO)
  dataUltimoContacto DateTime?
  proximaAccao       String?
  dataProximaAccao   DateTime?
  notas              String?
  fonte              String?
  ativo              Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  amostras           Amostra[]
  comunicacoes       Comunicacao[]
  orcamentos         Orcamento[]
  tactics            ProspectoTactic[]
  tarefas            Tarefa[]

  @@index([estado])
  @@index([cidade])
}

model Devolucao {
  id               String            @id @default(cuid())
  vendaId          String
  dataRegisto      DateTime          @default(now())
  motivo           String?
  totalDevolvido   Decimal           @db.Decimal(10, 2)
  totalSubstituido Decimal           @default(0) @db.Decimal(10, 2)
  estado           EstadoDevolucao   @default(PENDENTE)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  venda            Venda             @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  imagens          ImagemDevolucao[]
  itens            ItemDevolucao[]

  @@index([vendaId])
  @@index([estado])
}

model ItemDevolucao {
  id                   String    @id @default(cuid())
  devolucaoId          String
  itemVendaId          String
  quantidade           Decimal   @db.Decimal(10, 2)
  valorUnitario        Decimal   @db.Decimal(10, 2)
  subtotal             Decimal   @db.Decimal(10, 2)
  motivo               String
  substituicaoId       String?
  qtdSubstituicao      Decimal?  @db.Decimal(10, 2)
  precoSubstituicao    Decimal?  @db.Decimal(10, 2)
  subtotalSubstituicao Decimal?  @db.Decimal(10, 2)
  createdAt            DateTime  @default(now())
  devolucao            Devolucao @relation(fields: [devolucaoId], references: [id], onDelete: Cascade)
  itemVenda            ItemVenda @relation(fields: [itemVendaId], references: [id])
  substituicao         Produto?  @relation("Substituicao", fields: [substituicaoId], references: [id])

  @@index([devolucaoId])
  @@index([itemVendaId])
}

model ImagemDevolucao {
  id           String    @id @default(cuid())
  devolucaoId  String
  caminho      String
  nomeOriginal String
  tamanho      Int
  tipo         String
  createdAt    DateTime  @default(now())
  devolucao    Devolucao @relation(fields: [devolucaoId], references: [id], onDelete: Cascade)

  @@index([devolucaoId])
}

model ReconciliacaoMensal {
  id                String              @id @default(cuid())
  mes               Int
  ano               Int
  nomeArquivo       String
  caminhoArquivo    String
  dataInicio        DateTime?
  dataFim           DateTime?
  totalBrutoPdf     Decimal             @db.Decimal(10, 2)
  totalDescontosPdf Decimal             @db.Decimal(10, 2)
  totalLiquidoPdf   Decimal             @db.Decimal(10, 2)
  totalSistema      Decimal             @db.Decimal(10, 2)
  diferenca         Decimal             @default(0) @db.Decimal(10, 2)
  totalItens        Int
  itensCorretos     Int                 @default(0)
  itensComProblema  Int                 @default(0)
  estado            EstadoReconciliacao @default(PENDENTE)
  notas             String?
  dataUpload        DateTime            @default(now())
  dataRevisao       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  itens             ItemReconciliacao[]

  @@unique([mes, ano])
  @@index([estado])
}

model ItemReconciliacao {
  id               String              @id @default(cuid())
  reconciliacaoId  String
  codigoClientePdf String
  nomeClientePdf   String
  valorBrutoPdf    Decimal             @db.Decimal(10, 2)
  descontoPdf      Decimal             @db.Decimal(10, 2)
  valorLiquidoPdf  Decimal             @db.Decimal(10, 2)
  clienteId        String?
  vendaId          String?
  valorSistema     Decimal?            @db.Decimal(10, 2)
  corresponde      Boolean             @default(false)
  tipoDiscrepancia TipoDiscrepancia?
  diferencaValor   Decimal?            @db.Decimal(10, 2)
  resolvido        Boolean             @default(false)
  notaResolucao    String?
  createdAt        DateTime            @default(now())
  cliente          Cliente?            @relation(fields: [clienteId], references: [id])
  reconciliacao    ReconciliacaoMensal @relation(fields: [reconciliacaoId], references: [id], onDelete: Cascade)
  venda            Venda?              @relation(fields: [vendaId], references: [id])

  @@index([reconciliacaoId])
  @@index([clienteId])
  @@index([corresponde])
}

model ClienteInsight {
  id        String   @id @default(cuid())
  clienteId String
  insights  Json
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
}

model ProspectoTactic {
  id          String    @id @default(cuid())
  prospectoId String
  tactics     Json
  provider    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  prospecto   Prospecto @relation(fields: [prospectoId], references: [id], onDelete: Cascade)

  @@index([prospectoId])
}

model Tarefa {
  id             String           @id @default(cuid())
  titulo         String
  descricao      String?
  tipo           String?
  prioridade     PrioridadeTarefa @default(MEDIA)
  estado         EstadoTarefa     @default(PENDENTE)
  dataVencimento DateTime?
  dataLembrete   DateTime?
  dataConclusao  DateTime?
  clienteId      String?
  prospectoId    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  cliente        Cliente?         @relation(fields: [clienteId], references: [id])
  prospecto      Prospecto?       @relation(fields: [prospectoId], references: [id])

  @@index([clienteId])
  @@index([prospectoId])
  @@index([estado])
  @@index([dataVencimento])
  @@index([prioridade])
}

model Comunicacao {
  id           String          @id @default(cuid())
  clienteId    String?
  prospectoId  String?
  tipo         TipoComunicacao
  assunto      String?
  notas        String?
  dataContacto DateTime        @default(now())
  duracao      Int?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  cliente      Cliente?        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  prospecto    Prospecto?      @relation(fields: [prospectoId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@index([prospectoId])
  @@index([dataContacto])
}

model ClienteSegmento {
  id              String          @id @default(cuid())
  clienteId       String          @unique
  segmento        SegmentoCliente @default(C)
  tags            String[]
  potencialMensal Decimal?        @db.Decimal(10, 2)
  notas           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  cliente         Cliente         @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([segmento])
}

model Amostra {
  id            String      @id @default(cuid())
  clienteId     String?
  prospectoId   String?
  produtoId     String?
  tipo          TipoAmostra @default(AMOSTRA)
  descricao     String?
  quantidade    Int         @default(1)
  valorEstimado Decimal?    @db.Decimal(10, 2)
  dataEntrega   DateTime    @default(now())
  notas         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  cliente       Cliente?    @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  produto       Produto?    @relation(fields: [produtoId], references: [id])
  prospecto     Prospecto?  @relation(fields: [prospectoId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@index([prospectoId])
  @@index([produtoId])
}

model Orcamento {
  id           String          @id @default(cuid())
  numero       String          @unique
  prospectoId  String?
  clienteId    String?
  titulo       String?
  introducao   String?
  condicoes    String?
  validadeDias Int             @default(30)
  dataEmissao  DateTime        @default(now())
  dataValidade DateTime?
  subtotal     Decimal         @db.Decimal(10, 2)
  desconto     Decimal         @default(0) @db.Decimal(10, 2)
  iva          Decimal         @db.Decimal(10, 2)
  total        Decimal         @db.Decimal(10, 2)
  estado       EstadoOrcamento @default(RASCUNHO)
  notas        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  itens        ItemOrcamento[]
  cliente      Cliente?        @relation(fields: [clienteId], references: [id])
  prospecto    Prospecto?      @relation(fields: [prospectoId], references: [id])

  @@index([prospectoId])
  @@index([clienteId])
  @@index([estado])
}

model ItemOrcamento {
  id          String    @id @default(cuid())
  orcamentoId String
  produtoId   String?
  descricao   String
  quantidade  Decimal   @db.Decimal(10, 2)
  precoUnit   Decimal   @db.Decimal(10, 2)
  desconto    Decimal   @default(0) @db.Decimal(10, 2)
  subtotal    Decimal   @db.Decimal(10, 2)
  ordem       Int       @default(0)
  createdAt   DateTime  @default(now())
  orcamento   Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  produto     Produto?  @relation(fields: [produtoId], references: [id])

  @@index([orcamentoId])
  @@index([produtoId])
}

model Notificacao {
  id          String          @id @default(cuid())
  tipo        TipoNotificacao
  titulo      String
  mensagem    String
  lida        Boolean         @default(false)
  clienteId   String?
  prospectoId String?
  tarefaId    String?
  parcelaId   String?
  createdAt   DateTime        @default(now())
  readAt      DateTime?

  @@index([lida])
  @@index([createdAt])
}

model ClienteHealth {
  id                String   @id @default(cuid())
  clienteId         String   @unique
  scoreGeral        Int      @default(50)
  scorePagamento    Int      @default(50)
  scoreEngajamento  Int      @default(50)
  scoreCompras      Int      @default(50)
  risco             String   @default("MEDIO")
  tendencia         String   @default("ESTAVEL")
  ultimaAtualizacao DateTime @default(now())

  @@index([scoreGeral])
  @@index([risco])
}

model PrevisaoVendas {
  id               String   @id @default(cuid())
  mes              Int
  ano              Int
  previsaoBase     Decimal  @db.Decimal(10, 2)
  previsaoPipeline Decimal  @db.Decimal(10, 2)
  previsaoTotal    Decimal  @db.Decimal(10, 2)
  confianca        Int      @default(70)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([mes, ano])
}

model Campanha {
  id              String            @id
  titulo          String
  descricao       String?
  mes             Int
  ano             Int
  ativo           Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  CampanhaProduto CampanhaProduto[]
  CampanhaVenda   CampanhaVenda[]

  @@index([ativo])
  @@index([mes, ano])
}

model CampanhaProduto {
  id         String   @id
  campanhaId String
  produtoId  String?
  nome       String
  precoUnit  Decimal  @db.Decimal(10, 2)
  quantidade Int      @default(1)
  createdAt  DateTime @default(now())
  Campanha   Campanha @relation(fields: [campanhaId], references: [id], onDelete: Cascade)
  Produto    Produto? @relation(fields: [produtoId], references: [id])

  @@index([campanhaId])
  @@index([produtoId])
}

model CampanhaVenda {
  id         String   @id
  campanhaId String
  vendaId    String
  quantidade Int      @default(1)
  createdAt  DateTime @default(now())
  Campanha   Campanha @relation(fields: [campanhaId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Venda      Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([campanhaId, vendaId])
  @@index([campanhaId])
  @@index([vendaId])
}

model MoodEntry {
  id        String   @id
  date      String   @unique
  rating    Int
  createdAt DateTime @default(now())

  @@index([date])
}

model RotaSalva {
  id                  String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  nome                String?
  data                DateTime  @db.Timestamp(6)
  origemLatitude      Float
  origemLongitude     Float
  origemEndereco      String?
  locais              Json
  distanciaTotal      String?
  duracaoTotal        String?
  concluida           Boolean?  @default(false)
  createdAt           DateTime? @default(now()) @db.Timestamp(6)
  updatedAt           DateTime? @default(now()) @db.Timestamp(6)
  paragens            Json?
  custoPortagens      Decimal?  @db.Decimal(10, 2)
  numPortagens        Int?
  custoCombuistivel   Decimal?  @db.Decimal(10, 2)
  consumoMedio        Decimal?  @db.Decimal(4, 1)
  precoLitro          Decimal?  @db.Decimal(4, 3)
  custoEstacionamento Decimal?  @db.Decimal(10, 2)
  custoTotal          Decimal?  @db.Decimal(10, 2)
  custoReal           Decimal?  @db.Decimal(10, 2)
  notasCustos         String?

  @@index([concluida])
  @@index([data])
}

enum EstadoPipeline {
  NOVO
  CONTACTADO
  REUNIAO
  PROPOSTA
  NEGOCIACAO
  GANHO
  PERDIDO
}

enum EstadoDevolucao {
  PENDENTE
  PROCESSADA
  CANCELADA
}

enum EstadoReconciliacao {
  PENDENTE
  EM_REVISAO
  APROVADA
  COM_PROBLEMAS
}

enum TipoDiscrepancia {
  VALOR_DIFERENTE
  CLIENTE_NAO_EXISTE
  VENDA_NAO_EXISTE
  VENDA_EXTRA
}

enum PrioridadeTarefa {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

enum EstadoTarefa {
  PENDENTE
  EM_PROGRESSO
  CONCLUIDA
  CANCELADA
}

enum TipoComunicacao {
  TELEFONEMA
  EMAIL
  VISITA
  WHATSAPP
  REUNIAO
  OUTRO
}

enum SegmentoCliente {
  A
  B
  C
}

enum TipoAmostra {
  AMOSTRA
  BRINDE
  DEMONSTRACAO
}

enum EstadoOrcamento {
  RASCUNHO
  ENVIADO
  ACEITE
  REJEITADO
  EXPIRADO
}

enum TipoNotificacao {
  PAGAMENTO_ATRASADO
  TAREFA_VENCIDA
  TAREFA_HOJE
  LEAD_PARADO
  CLIENTE_SEM_CONTACTO
  FORECAST_ALERT
  HEALTH_ALERT
}

model AcordoParceria {
  id              String    @id @default(cuid())
  clienteId       String    @unique
  cliente         Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  valorAnual      Decimal   @db.Decimal(10, 2)
  ano             Int
  dataInicio      DateTime  @default(now())
  dataFim         DateTime?
  ativo           Boolean   @default(true)
  notas           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([clienteId])
  @@index([ano])
  @@index([ativo])
}
