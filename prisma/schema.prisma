generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

enum UserRole {
  MASTERADMIN
  ADMIN
  SELLER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

model User {
  id                   String     @id @default(cuid())
  name                 String?
  email                String     @unique
  password             String
  role                 UserRole   @default(SELLER)
  status               UserStatus @default(PENDING)
  lastLoginAt          DateTime?
  resetPasswordToken   String?    @unique
  resetPasswordExpires DateTime?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  // Owned data relationships
  clientes        Cliente[]
  prospectos      Prospecto[]
  tarefas         Tarefa[]
  comunicacoes    Comunicacao[]
  amostras        Amostra[]
  orcamentos      Orcamento[]
  rotasSalvas     RotaSalva[]
  campanhas       Campanha[]
  moodEntries     MoodEntry[]
  objetivosVarios ObjetivoVario[]
  tokenBalance    TokenBalance?
  files           UserFile[]
  despesas        Despesa[]

  @@index([role])
  @@index([status])
}

model ImpersonationLog {
  id                 String    @id @default(cuid())
  impersonatorId     String
  impersonatedUserId String
  impersonatedEmail  String
  startedAt          DateTime  @default(now())
  endedAt            DateTime?

  @@index([impersonatorId])
  @@index([startedAt])
}

model Cliente {
  id                 String              @id @default(cuid())
  userId             String?
  nome               String
  codigo             String?             @unique
  telefone           String?
  email              String?
  morada             String?
  notas              String?
  ativo              Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  ultimoContacto     DateTime?
  cidade             String?
  codigoPostal       String?
  latitude           Float?
  longitude          Float?
  user               User?               @relation(fields: [userId], references: [id])
  amostras           Amostra[]
  insights           ClienteInsight[]
  segmento           ClienteSegmento?
  cobrancas          Cobranca[]
  comunicacoes       Comunicacao[]
  itensReconciliacao ItemReconciliacao[]
  orcamentos         Orcamento[]
  tarefas            Tarefa[]
  vendas             Venda[]
  acordoParceria     AcordoParceria?

  @@index([userId])
  @@index([ativo])
  @@index([ativo, ultimoContacto])
  @@index([nome])
}

model Venda {
  id                 String              @id @default(cuid())
  clienteId          String
  valor1             Decimal?            @db.Decimal(10, 2)
  valor2             Decimal?            @db.Decimal(10, 2)
  total              Decimal             @db.Decimal(10, 2)
  mes                Int
  ano                Int
  notas              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  objetivoVarioId    String?
  objetivoVarioValor Decimal?            @db.Decimal(10, 2)
  campanhas          CampanhaVenda[]
  cobranca           Cobranca?
  devolucoes         Devolucao[]
  incidencias        Incidencia[]
  itensReconciliacao ItemReconciliacao[]
  itens              ItemVenda[]
  cliente            Cliente             @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  objetivoVario      ObjetivoVario?      @relation(fields: [objetivoVarioId], references: [id])

  @@index([clienteId])
  @@index([mes, ano])
  @@index([objetivoVarioId])
  @@index([clienteId, mes, ano])
  @@index([ano])
}

model Cobranca {
  id                   String    @id @default(cuid())
  clienteId            String
  fatura               String?
  valor                Decimal   @db.Decimal(10, 2)
  valorSemIva          Decimal?  @db.Decimal(10, 2)
  comissao             Decimal?  @db.Decimal(10, 2)
  dataEmissao          DateTime?
  dataPago             DateTime?
  pago                 Boolean   @default(false)
  notas                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  dataInicioVencimento DateTime?
  numeroParcelas       Int       @default(1)
  vendaId              String?   @unique
  cliente              Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  venda                Venda?    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  parcelas             Parcela[]

  @@index([clienteId])
  @@index([pago])
  @@index([clienteId, pago])
  @@index([pago, createdAt])
}

model Parcela {
  id             String    @id @default(cuid())
  cobrancaId     String
  numero         Int
  valor          Decimal   @db.Decimal(10, 2)
  dataVencimento DateTime
  dataPago       DateTime?
  pago           Boolean   @default(false)
  notas          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  cobranca       Cobranca  @relation(fields: [cobrancaId], references: [id], onDelete: Cascade)

  @@unique([cobrancaId, numero])
  @@index([cobrancaId])
  @@index([dataVencimento])
  @@index([pago])
  @@index([pago, dataVencimento])
}

model ObjetivoMensal {
  id        String   @id @default(cuid())
  mes       Int
  ano       Int
  objetivo  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mes, ano])
}

model ObjetivoTrimestral {
  id        String   @id @default(cuid())
  trimestre Int
  ano       Int
  objetivo  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([trimestre, ano])
}

model ObjetivoAnual {
  id        String   @id @default(cuid())
  ano       Int      @unique
  objetivo  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Configuracao {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PremioMensal {
  id        String   @id @default(cuid())
  minimo    Decimal  @unique @db.Decimal(10, 2)
  premio    Decimal  @db.Decimal(10, 2)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PremioTrimestral {
  id        String   @id @default(cuid())
  minimo    Decimal  @unique @db.Decimal(10, 2)
  premio    Decimal  @db.Decimal(10, 2)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PremioAnual {
  id        String   @id @default(cuid())
  minimo    Decimal  @unique @db.Decimal(10, 2)
  premio    Decimal  @db.Decimal(10, 2)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Produto {
  id              String                 @id @default(cuid())
  nome            String
  codigo          String?                @unique
  categoria       String?
  descricao       String?
  ativo           Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  preco           Decimal?               @db.Decimal(10, 2)
  tipo            String?
  amostras        Amostra[]
  produtos        CampanhaProduto[]
  substituicoes   ItemDevolucao[]        @relation("Substituicao")
  itensOrcamento  ItemOrcamento[]
  itensVenda      ItemVenda[]
  objetivosVarios ObjetivoVarioProduto[]
}

model ItemVenda {
  id         String          @id @default(cuid())
  vendaId    String
  produtoId  String
  quantidade Decimal         @db.Decimal(10, 2)
  precoUnit  Decimal         @db.Decimal(10, 2)
  subtotal   Decimal         @db.Decimal(10, 2)
  createdAt  DateTime        @default(now())
  devolucoes ItemDevolucao[]
  produto    Produto         @relation(fields: [produtoId], references: [id])
  venda      Venda           @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  @@index([vendaId])
  @@index([produtoId])
}

model Prospecto {
  id                 String            @id @default(cuid())
  userId             String?
  nomeEmpresa        String
  tipoNegocio        String?
  website            String?
  facebook           String?
  instagram          String?
  nomeContacto       String?
  cargoContacto      String?
  telefone           String?
  email              String?
  morada             String?
  cidade             String?
  codigoPostal       String?
  latitude           Float?
  longitude          Float?
  estado             EstadoPipeline    @default(NOVO)
  dataUltimoContacto DateTime?
  proximaAccao       String?
  dataProximaAccao   DateTime?
  notas              String?
  fonte              String?
  ativo              Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  user               User?             @relation(fields: [userId], references: [id])
  amostras           Amostra[]
  comunicacoes       Comunicacao[]
  orcamentos         Orcamento[]
  tactics            ProspectoTactic[]
  tarefas            Tarefa[]

  @@index([userId])
  @@index([estado])
  @@index([cidade])
  @@index([ativo, estado])
  @@index([ativo, dataUltimoContacto])
}

model Devolucao {
  id               String            @id @default(cuid())
  vendaId          String
  dataRegisto      DateTime          @default(now())
  motivo           String?
  totalDevolvido   Decimal           @db.Decimal(10, 2)
  totalSubstituido Decimal           @default(0) @db.Decimal(10, 2)
  estado           EstadoDevolucao   @default(PENDENTE)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  venda            Venda             @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  imagens          ImagemDevolucao[]
  itens            ItemDevolucao[]

  @@index([vendaId])
  @@index([estado])
}

model ItemDevolucao {
  id                   String    @id @default(cuid())
  devolucaoId          String
  itemVendaId          String
  quantidade           Decimal   @db.Decimal(10, 2)
  valorUnitario        Decimal   @db.Decimal(10, 2)
  subtotal             Decimal   @db.Decimal(10, 2)
  motivo               String
  substituicaoId       String?
  qtdSubstituicao      Decimal?  @db.Decimal(10, 2)
  precoSubstituicao    Decimal?  @db.Decimal(10, 2)
  subtotalSubstituicao Decimal?  @db.Decimal(10, 2)
  createdAt            DateTime  @default(now())
  devolucao            Devolucao @relation(fields: [devolucaoId], references: [id], onDelete: Cascade)
  itemVenda            ItemVenda @relation(fields: [itemVendaId], references: [id])
  substituicao         Produto?  @relation("Substituicao", fields: [substituicaoId], references: [id])

  @@index([devolucaoId])
  @@index([itemVendaId])
}

model ImagemDevolucao {
  id           String    @id @default(cuid())
  devolucaoId  String
  caminho      String
  nomeOriginal String
  tamanho      Int
  tipo         String
  createdAt    DateTime  @default(now())
  devolucao    Devolucao @relation(fields: [devolucaoId], references: [id], onDelete: Cascade)

  @@index([devolucaoId])
}

model ReconciliacaoMensal {
  id                String              @id @default(cuid())
  mes               Int
  ano               Int
  nomeArquivo       String
  caminhoArquivo    String
  dataInicio        DateTime?
  dataFim           DateTime?
  totalBrutoPdf     Decimal             @db.Decimal(10, 2)
  totalDescontosPdf Decimal             @db.Decimal(10, 2)
  totalLiquidoPdf   Decimal             @db.Decimal(10, 2)
  totalSistema      Decimal             @db.Decimal(10, 2)
  diferenca         Decimal             @default(0) @db.Decimal(10, 2)
  totalItens        Int
  itensCorretos     Int                 @default(0)
  itensComProblema  Int                 @default(0)
  estado            EstadoReconciliacao @default(PENDENTE)
  notas             String?
  dataUpload        DateTime            @default(now())
  dataRevisao       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  itens             ItemReconciliacao[]

  @@index([mes, ano])
  @@index([estado])
}

model ItemReconciliacao {
  id                   String              @id @default(cuid())
  reconciliacaoId      String
  codigoClientePdf     String
  nomeClientePdf       String
  valorBrutoPdf        Decimal             @db.Decimal(10, 2)
  descontoPdf          Decimal             @db.Decimal(10, 2)
  valorLiquidoPdf      Decimal             @db.Decimal(10, 2)
  clienteId            String?
  vendaId              String?
  valorSistema         Decimal?            @db.Decimal(10, 2)
  valorVendas          Decimal?            @db.Decimal(10, 2) // Value from regular sales only
  valorObjetivosVarios Decimal?            @db.Decimal(10, 2) // Value from objetivos varios
  corresponde          Boolean             @default(false)
  tipoDiscrepancia     TipoDiscrepancia?
  diferencaValor       Decimal?            @db.Decimal(10, 2)
  resolvido            Boolean             @default(false)
  notaResolucao        String?
  createdAt            DateTime            @default(now())
  cliente              Cliente?            @relation(fields: [clienteId], references: [id])
  reconciliacao        ReconciliacaoMensal @relation(fields: [reconciliacaoId], references: [id], onDelete: Cascade)
  venda                Venda?              @relation(fields: [vendaId], references: [id])

  @@index([reconciliacaoId])
  @@index([clienteId])
  @@index([corresponde])
}

model ClienteInsight {
  id        String   @id @default(cuid())
  clienteId String
  insights  Json
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
}

model ProspectoTactic {
  id          String    @id @default(cuid())
  prospectoId String
  tactics     Json
  provider    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  prospecto   Prospecto @relation(fields: [prospectoId], references: [id], onDelete: Cascade)

  @@index([prospectoId])
}

model Tarefa {
  id             String           @id @default(cuid())
  userId         String?
  titulo         String
  descricao      String?
  tipo           String?
  prioridade     PrioridadeTarefa @default(MEDIA)
  estado         EstadoTarefa     @default(PENDENTE)
  dataVencimento DateTime?
  dataLembrete   DateTime?
  dataConclusao  DateTime?
  clienteId      String?
  prospectoId    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])
  cliente        Cliente?         @relation(fields: [clienteId], references: [id])
  prospecto      Prospecto?       @relation(fields: [prospectoId], references: [id])

  @@index([userId])
  @@index([clienteId])
  @@index([prospectoId])
  @@index([estado])
  @@index([dataVencimento])
  @@index([prioridade])
  @@index([userId, estado, dataVencimento])
}

model Comunicacao {
  id           String          @id @default(cuid())
  userId       String?
  clienteId    String?
  prospectoId  String?
  tipo         TipoComunicacao
  assunto      String?
  notas        String?
  dataContacto DateTime        @default(now())
  duracao      Int?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  user         User?           @relation(fields: [userId], references: [id])
  cliente      Cliente?        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  prospecto    Prospecto?      @relation(fields: [prospectoId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clienteId])
  @@index([prospectoId])
  @@index([dataContacto])
  @@index([clienteId, dataContacto])
  @@index([prospectoId, dataContacto])
}

model ClienteSegmento {
  id              String          @id @default(cuid())
  clienteId       String          @unique
  segmento        SegmentoCliente @default(C)
  tags            String[]
  potencialMensal Decimal?        @db.Decimal(10, 2)
  notas           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  cliente         Cliente         @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([segmento])
}

model Amostra {
  id            String      @id @default(cuid())
  userId        String?
  clienteId     String?
  prospectoId   String?
  produtoId     String?
  tipo          TipoAmostra @default(AMOSTRA)
  descricao     String?
  quantidade    Int         @default(1)
  valorEstimado Decimal?    @db.Decimal(10, 2)
  dataEntrega   DateTime    @default(now())
  notas         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User?       @relation(fields: [userId], references: [id])
  cliente       Cliente?    @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  produto       Produto?    @relation(fields: [produtoId], references: [id])
  prospecto     Prospecto?  @relation(fields: [prospectoId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clienteId])
  @@index([prospectoId])
  @@index([produtoId])
}

model Orcamento {
  id           String          @id @default(cuid())
  userId       String?
  numero       String          @unique
  prospectoId  String?
  clienteId    String?
  titulo       String?
  introducao   String?
  condicoes    String?
  validadeDias Int             @default(30)
  dataEmissao  DateTime        @default(now())
  dataValidade DateTime?
  subtotal     Decimal         @db.Decimal(10, 2)
  desconto     Decimal         @default(0) @db.Decimal(10, 2)
  iva          Decimal         @db.Decimal(10, 2)
  total        Decimal         @db.Decimal(10, 2)
  estado       EstadoOrcamento @default(RASCUNHO)
  notas        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  user         User?           @relation(fields: [userId], references: [id])
  itens        ItemOrcamento[]
  cliente      Cliente?        @relation(fields: [clienteId], references: [id])
  prospecto    Prospecto?      @relation(fields: [prospectoId], references: [id])

  @@index([userId])
  @@index([prospectoId])
  @@index([clienteId])
  @@index([estado])
}

model ItemOrcamento {
  id          String    @id @default(cuid())
  orcamentoId String
  produtoId   String?
  descricao   String
  quantidade  Decimal   @db.Decimal(10, 2)
  precoUnit   Decimal   @db.Decimal(10, 2)
  desconto    Decimal   @default(0) @db.Decimal(10, 2)
  subtotal    Decimal   @db.Decimal(10, 2)
  ordem       Int       @default(0)
  createdAt   DateTime  @default(now())
  orcamento   Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  produto     Produto?  @relation(fields: [produtoId], references: [id])

  @@index([orcamentoId])
  @@index([produtoId])
}

model Notificacao {
  id          String          @id @default(cuid())
  tipo        TipoNotificacao
  titulo      String
  mensagem    String
  lida        Boolean         @default(false)
  clienteId   String?
  prospectoId String?
  tarefaId    String?
  parcelaId   String?
  createdAt   DateTime        @default(now())
  readAt      DateTime?

  @@index([lida])
  @@index([createdAt])
}

model ClienteHealth {
  id                String   @id @default(cuid())
  clienteId         String   @unique
  scoreGeral        Int      @default(50)
  scorePagamento    Int      @default(50)
  scoreEngajamento  Int      @default(50)
  scoreCompras      Int      @default(50)
  risco             String   @default("MEDIO")
  tendencia         String   @default("ESTAVEL")
  ultimaAtualizacao DateTime @default(now())

  @@index([scoreGeral])
  @@index([risco])
}

model PrevisaoVendas {
  id               String   @id @default(cuid())
  mes              Int
  ano              Int
  previsaoBase     Decimal  @db.Decimal(10, 2)
  previsaoPipeline Decimal  @db.Decimal(10, 2)
  previsaoTotal    Decimal  @db.Decimal(10, 2)
  confianca        Int      @default(70)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([mes, ano])
}

model Campanha {
  id        String            @id @default(cuid())
  userId    String?
  titulo    String
  descricao String?
  mes       Int
  ano       Int
  ativo     Boolean           @default(true)
  recorrente Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  user      User?             @relation(fields: [userId], references: [id])
  produtos  CampanhaProduto[]
  vendas    CampanhaVenda[]

  @@index([userId])
  @@index([ativo])
  @@index([mes, ano])
  @@index([recorrente])
}

model CampanhaProduto {
  id         String   @id @default(cuid())
  campanhaId String
  produtoId  String?
  nome       String
  precoUnit  Decimal  @db.Decimal(10, 2)
  quantidade Int      @default(1)
  createdAt  DateTime @default(now())
  campanha   Campanha @relation(fields: [campanhaId], references: [id], onDelete: Cascade)
  produto    Produto? @relation(fields: [produtoId], references: [id])

  @@index([campanhaId])
  @@index([produtoId])
}

model CampanhaVenda {
  id         String   @id @default(cuid())
  campanhaId String
  vendaId    String
  quantidade Int      @default(1)
  createdAt  DateTime @default(now())
  campanha   Campanha @relation(fields: [campanhaId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  venda      Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([campanhaId, vendaId])
  @@index([campanhaId])
  @@index([vendaId])
}

model ObjetivoVario {
  id        String                 @id @default(cuid())
  userId    String?
  titulo    String
  descricao String?
  mes       Int
  ano       Int
  ativo     Boolean                @default(true)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  user      User?                  @relation(fields: [userId], references: [id])
  produtos  ObjetivoVarioProduto[]
  vendas    Venda[]
  metas     ObjetivoVarioMeta[]

  @@index([userId])
  @@index([ativo])
  @@index([mes, ano])
}

model ObjetivoVarioProduto {
  id              String        @id @default(cuid())
  objetivoVarioId String
  produtoId       String?
  nome            String
  precoSemIva     Decimal       @db.Decimal(10, 2)
  quantidade      Int           @default(1)
  createdAt       DateTime      @default(now())
  objetivoVario   ObjetivoVario @relation(fields: [objetivoVarioId], references: [id], onDelete: Cascade)
  produto         Produto?      @relation(fields: [produtoId], references: [id])

  @@index([objetivoVarioId])
  @@index([produtoId])
}

model MoodEntry {
  id        String   @id @default(cuid())
  userId    String?
  date      String
  rating    Int
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model RotaSalva {
  id                  String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId              String?
  nome                String?
  data                DateTime  @db.Timestamp(6)
  origemLatitude      Float
  origemLongitude     Float
  origemEndereco      String?
  locais              Json
  distanciaTotal      String?
  duracaoTotal        String?
  concluida           Boolean?  @default(false)
  createdAt           DateTime? @default(now()) @db.Timestamp(6)
  updatedAt           DateTime? @default(now()) @db.Timestamp(6)
  paragens            Json?
  custoPortagens      Decimal?  @db.Decimal(10, 2)
  numPortagens        Int?
  custoCombuistivel   Decimal?  @db.Decimal(10, 2)
  consumoMedio        Decimal?  @db.Decimal(4, 1)
  precoLitro          Decimal?  @db.Decimal(4, 3)
  custoEstacionamento Decimal?  @db.Decimal(10, 2)
  custoTotal          Decimal?  @db.Decimal(10, 2)
  custoReal           Decimal?  @db.Decimal(10, 2)
  notasCustos         String?
  user                User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([concluida])
  @@index([data])
}

enum EstadoPipeline {
  NOVO
  CONTACTADO
  REUNIAO
  PROPOSTA
  NEGOCIACAO
  GANHO
  PERDIDO
}

enum EstadoDevolucao {
  PENDENTE
  PROCESSADA
  CANCELADA
}

enum EstadoReconciliacao {
  PENDENTE
  EM_REVISAO
  APROVADA
  COM_PROBLEMAS
}

enum TipoDiscrepancia {
  VALOR_DIFERENTE
  CLIENTE_NAO_EXISTE
  VENDA_NAO_EXISTE
  VENDA_EXTRA
}

enum PrioridadeTarefa {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

enum EstadoTarefa {
  PENDENTE
  EM_PROGRESSO
  CONCLUIDA
  CANCELADA
}

enum TipoComunicacao {
  TELEFONEMA
  EMAIL
  VISITA
  WHATSAPP
  REUNIAO
  OUTRO
}

enum SegmentoCliente {
  A
  B
  C
}

enum TipoAmostra {
  AMOSTRA
  BRINDE
  DEMONSTRACAO
}

enum EstadoOrcamento {
  RASCUNHO
  ENVIADO
  ACEITE
  REJEITADO
  EXPIRADO
}

enum TipoNotificacao {
  PAGAMENTO_ATRASADO
  TAREFA_VENCIDA
  TAREFA_HOJE
  LEAD_PARADO
  CLIENTE_SEM_CONTACTO
  FORECAST_ALERT
  HEALTH_ALERT
}

model AcordoParceria {
  id         String    @id @default(cuid())
  clienteId  String    @unique
  cliente    Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  valorAnual Decimal   @db.Decimal(10, 2)
  ano        Int
  dataInicio DateTime  @default(now())
  dataFim    DateTime?
  ativo      Boolean   @default(true)
  notas      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([clienteId])
  @@index([ano])
  @@index([ativo])
}

// ==========================================
// AI Token System
// ==========================================

model TokenBalance {
  id          String   @id @default(cuid())
  userId      String   @unique
  tokensTotal Int      @default(0)
  tokensUsed  Int      @default(0)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model TokenUsage {
  id           String   @id @default(cuid())
  userId       String
  inputTokens  Int
  outputTokens Int
  totalTokens  Int
  costEur      Decimal  @db.Decimal(10, 6)
  feature      String
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model TokenPurchase {
  id              String              @id @default(cuid())
  userId          String
  tokens          Int
  amountEur       Decimal             @db.Decimal(10, 2)
  stripeSessionId String?             @unique
  stripePaymentId String?             @unique
  status          TokenPurchaseStatus @default(PENDING)
  createdAt       DateTime            @default(now())
  completedAt     DateTime?

  @@index([userId])
  @@index([status])
  @@index([stripeSessionId])
}

model TokenAllocation {
  id          String   @id @default(cuid())
  userId      String
  tokens      Int
  allocatedBy String
  reason      String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([allocatedBy])
}

enum TokenPurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ===========================================
// AI Insights Models
// ===========================================

enum InsightType {
  DASHBOARD
  COBRANCA_RISK
  VENDAS_TREND
  PRODUTO_PERFORMANCE
}

model AIInsight {
  id        String      @id @default(cuid())
  userId    String
  type      InsightType
  data      Json
  summary   String?     @db.Text
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  expiresAt DateTime?

  @@unique([userId, type])
  @@index([userId])
  @@index([type])
}

model CobrancaRisk {
  id           String   @id @default(cuid())
  cobrancaId   String   @unique
  riskLevel    String   // HIGH, MEDIUM, LOW
  riskScore    Int      // 0-100
  factors      Json     // Array of risk factors
  suggestions  Json     // Array of suggested actions
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([riskLevel])
}

model ProdutoInsight {
  id         String   @id @default(cuid())
  produtoId  String   @unique
  insights   Json
  trend      String?  // UP, DOWN, STABLE
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([produtoId])
}

model BaborellaChat {
  id          String   @id @default(cuid())
  userId      String
  entityType  String   // 'cliente' or 'prospecto'
  entityId    String
  messages    Json     // Array of {role, content, timestamp}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, entityType, entityId])
  @@index([userId])
  @@index([entityType, entityId])
}

model UserFile {
  id         String   @id @default(cuid())
  userId     String
  filename   String
  storedName String   @unique
  mimeType   String
  size       Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

model ObjetivoVarioMeta {
  id              String        @id @default(cuid())
  objetivoVarioId String
  mes             Int
  ano             Int
  objetivo        Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  objetivoVario   ObjetivoVario @relation(fields: [objetivoVarioId], references: [id], onDelete: Cascade)

  @@unique([objetivoVarioId, mes, ano])
  @@index([objetivoVarioId])
  @@index([mes, ano])
}

model ObjetivoNovosClientesAnual {
  id        String   @id @default(cuid())
  ano       Int      @unique
  objetivo  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ObjetivoNovosClientesTrimestral {
  id        String   @id @default(cuid())
  trimestre Int
  ano       Int
  objetivo  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([trimestre, ano])
}

// Despesas (Expenses) - Alpha Feature
model Despesa {
  id          String          @id @default(cuid())
  userId      String
  tipo        TipoDespesa
  valor       Decimal         @db.Decimal(10, 2)
  data        DateTime
  descricao   String?
  mes         Int
  ano         Int
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  imagens     DespesaImagem[]

  @@index([userId])
  @@index([userId, mes, ano])
  @@index([mes, ano])
}

model DespesaImagem {
  id         String   @id @default(cuid())
  despesaId  String
  filename   String
  storedName String   @unique
  mimeType   String
  size       Int
  createdAt  DateTime @default(now())
  despesa    Despesa  @relation(fields: [despesaId], references: [id], onDelete: Cascade)

  @@index([despesaId])
}

enum TipoDespesa {
  HOTEL
  COMBUSTIVEL
  GLP
  ESTACIONAMENTO
  PORTAGENS
  RESTAURANTE
  OUTRO
}

model Incidencia {
  id          String   @id @default(cuid())
  vendaId     String
  valor       Decimal  @db.Decimal(10, 2)
  motivo      String
  notas       String?
  dataRegisto DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  venda       Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  @@index([vendaId])
}
