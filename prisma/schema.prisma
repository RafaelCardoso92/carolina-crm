generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Cliente {
  id        String    @id @default(cuid())
  nome      String
  codigo    String?   @unique
  telefone  String?
  email     String?
  morada    String?
  notas     String?
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  vendas    Venda[]
  cobrancas Cobranca[]
  itensReconciliacao ItemReconciliacao[]
}

model Venda {
  id          String   @id @default(cuid())
  clienteId   String
  cliente     Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  valor1      Decimal? @db.Decimal(10, 2)
  valor2      Decimal? @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)

  mes         Int      // 1-12
  ano         Int

  notas       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  itens       ItemVenda[]
  devolucoes  Devolucao[]
  itensReconciliacao ItemReconciliacao[]

  @@index([clienteId])
  @@index([mes, ano])
}

model Cobranca {
  id          String    @id @default(cuid())
  clienteId   String
  cliente     Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  fatura      String?   // FA number
  valor       Decimal   @db.Decimal(10, 2)
  valorSemIva Decimal?  @db.Decimal(10, 2)
  comissao    Decimal?  @db.Decimal(10, 2)

  dataEmissao DateTime?
  dataPago    DateTime?
  pago        Boolean   @default(false)

  // Installment fields
  numeroParcelas       Int       @default(1)  // Total installments (1 = single payment)
  dataInicioVencimento DateTime? // First installment due date

  notas       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  parcelas    Parcela[]

  @@index([clienteId])
  @@index([pago])
}

model Parcela {
  id             String    @id @default(cuid())
  cobrancaId     String
  cobranca       Cobranca  @relation(fields: [cobrancaId], references: [id], onDelete: Cascade)

  numero         Int       // Installment number (1, 2, 3, ...)
  valor          Decimal   @db.Decimal(10, 2)
  dataVencimento DateTime  // Due date
  dataPago       DateTime? // Payment date (null if unpaid)
  pago           Boolean   @default(false)
  notas          String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([cobrancaId, numero])
  @@index([cobrancaId])
  @@index([dataVencimento])
  @@index([pago])
}

model ObjetivoMensal {
  id        String   @id @default(cuid())
  mes       Int      // 1-12
  ano       Int
  objetivo  Decimal  @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mes, ano])
}

model ObjetivoTrimestral {
  id        String   @id @default(cuid())
  trimestre Int      // 1-4
  ano       Int
  objetivo  Decimal  @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([trimestre, ano])
}

model ObjetivoAnual {
  id        String   @id @default(cuid())
  ano       Int      @unique
  objetivo  Decimal  @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Configuracao {
  id              String   @id @default(cuid())
  chave           String   @unique
  valor           String
  descricao       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PremioMensal {
  id              String   @id @default(cuid())
  minimo          Decimal  @db.Decimal(10, 2)  // Minimum sales to get this prize
  premio          Decimal  @db.Decimal(10, 2)  // Prize amount
  ordem           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([minimo])
}

model PremioTrimestral {
  id              String   @id @default(cuid())
  minimo          Decimal  @db.Decimal(10, 2)  // Minimum sales to get this prize
  premio          Decimal  @db.Decimal(10, 2)  // Prize amount
  ordem           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([minimo])
}

model PremioAnual {
  id              String   @id @default(cuid())
  minimo          Decimal  @db.Decimal(10, 2)  // Minimum sales to get this prize
  premio          Decimal  @db.Decimal(10, 2)  // Prize amount
  ordem           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([minimo])
}

model Produto {
  id          String   @id @default(cuid())
  nome        String
  codigo      String?  @unique
  categoria   String?
  descricao   String?
  ativo       Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  itensVenda      ItemVenda[]
  substituicoes   ItemDevolucao[] @relation("Substituicao")
}

model ItemVenda {
  id          String   @id @default(cuid())
  vendaId     String
  venda       Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  produtoId   String
  produto     Produto  @relation(fields: [produtoId], references: [id])

  quantidade  Decimal  @db.Decimal(10, 2)  // Allow decimals (e.g., 1.5 kg)
  precoUnit   Decimal  @db.Decimal(10, 2)  // Price per unit (with VAT)
  subtotal    Decimal  @db.Decimal(10, 2)  // quantidade * precoUnit

  createdAt   DateTime @default(now())

  devolucoes  ItemDevolucao[]

  @@index([vendaId])
  @@index([produtoId])
}

// Pipeline states for prospects
enum EstadoPipeline {
  NOVO           // New lead
  CONTACTADO     // Contacted
  REUNIAO        // Meeting scheduled/done
  PROPOSTA       // Proposal sent
  NEGOCIACAO     // In negotiation
  GANHO          // Won - convert to Cliente
  PERDIDO        // Lost
}

// Prospects/Leads model
model Prospecto {
  id              String          @id @default(cuid())

  // Business Info
  nomeEmpresa     String          // Business name
  tipoNegocio     String?         // Type of business
  website         String?
  facebook        String?
  instagram       String?

  // Contact Person
  nomeContacto    String?         // Contact person name
  cargoContacto   String?         // Contact person role/title
  telefone        String?
  email           String?

  // Location (for map)
  morada          String?         // Full address
  cidade          String?
  codigoPostal    String?
  latitude        Float?
  longitude       Float?

  // Pipeline
  estado          EstadoPipeline  @default(NOVO)
  dataUltimoContacto DateTime?
  proximaAccao    String?         // Next action to take
  dataProximaAccao DateTime?

  // Notes & metadata
  notas           String?         @db.Text
  fonte           String?         // Lead source (referral, website, etc)
  ativo           Boolean         @default(true)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([estado])
  @@index([cidade])
}

// ==========================================
// RETURNS (DEVOLUCOES) MODELS
// ==========================================

enum EstadoDevolucao {
  PENDENTE
  PROCESSADA
  CANCELADA
}

model Devolucao {
  id              String            @id @default(cuid())
  vendaId         String
  venda           Venda             @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  dataRegisto     DateTime          @default(now())
  motivo          String?           @db.Text  // General reason/notes

  // Calculated totals (with VAT)
  totalDevolvido    Decimal         @db.Decimal(10, 2)  // Sum of returned items value
  totalSubstituido  Decimal         @db.Decimal(10, 2) @default(0)  // Value of replacements

  // Status
  estado          EstadoDevolucao   @default(PENDENTE)

  itens           ItemDevolucao[]
  imagens         ImagemDevolucao[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([vendaId])
  @@index([estado])
}

model ItemDevolucao {
  id              String      @id @default(cuid())
  devolucaoId     String
  devolucao       Devolucao   @relation(fields: [devolucaoId], references: [id], onDelete: Cascade)

  // Original item reference
  itemVendaId     String
  itemVenda       ItemVenda   @relation(fields: [itemVendaId], references: [id])

  quantidade      Decimal     @db.Decimal(10, 2)  // Quantity returned
  valorUnitario   Decimal     @db.Decimal(10, 2)  // Unit price at time of return
  subtotal        Decimal     @db.Decimal(10, 2)  // quantidade * valorUnitario
  motivo          String                          // Reason for this item return

  // Optional replacement product
  substituicaoId      String?
  substituicao        Produto?  @relation("Substituicao", fields: [substituicaoId], references: [id])
  qtdSubstituicao     Decimal?  @db.Decimal(10, 2)
  precoSubstituicao   Decimal?  @db.Decimal(10, 2)
  subtotalSubstituicao Decimal? @db.Decimal(10, 2)

  createdAt       DateTime    @default(now())

  @@index([devolucaoId])
  @@index([itemVendaId])
}

model ImagemDevolucao {
  id              String      @id @default(cuid())
  devolucaoId     String
  devolucao       Devolucao   @relation(fields: [devolucaoId], references: [id], onDelete: Cascade)

  caminho         String      // File path on server (relative to uploads dir)
  nomeOriginal    String      // Original filename
  tamanho         Int         // File size in bytes
  tipo            String      // MIME type

  createdAt       DateTime    @default(now())

  @@index([devolucaoId])
}

// ==========================================
// SALES RECONCILIATION (MAPA 104)
// ==========================================

enum EstadoReconciliacao {
  PENDENTE      // Uploaded but not reviewed
  EM_REVISAO    // Being reviewed
  APROVADA      // All matches confirmed
  COM_PROBLEMAS // Has unresolved discrepancies
}

enum TipoDiscrepancia {
  VALOR_DIFERENTE     // Amount doesn't match
  CLIENTE_NAO_EXISTE  // Client in PDF not in system
  VENDA_NAO_EXISTE    // Client exists but no sale recorded
  VENDA_EXTRA         // Sale in system not in PDF
}

model ReconciliacaoMensal {
  id              String              @id @default(cuid())
  mes             Int
  ano             Int

  // PDF file info
  nomeArquivo     String              // Original filename
  caminhoArquivo  String              // Path to stored file

  // Date range from PDF
  dataInicio      DateTime?
  dataFim         DateTime?

  // Extracted totals from PDF
  totalBrutoPdf     Decimal           @db.Decimal(10, 2)
  totalDescontosPdf Decimal           @db.Decimal(10, 2)
  totalLiquidoPdf   Decimal           @db.Decimal(10, 2)

  // System totals for comparison
  totalSistema      Decimal           @db.Decimal(10, 2)

  // Difference
  diferenca         Decimal           @db.Decimal(10, 2) @default(0)

  // Summary
  totalItens        Int               // Number of client lines in PDF
  itensCorretos     Int               @default(0)
  itensComProblema  Int               @default(0)

  estado          EstadoReconciliacao @default(PENDENTE)
  notas           String?             @db.Text

  dataUpload      DateTime            @default(now())
  dataRevisao     DateTime?

  itens           ItemReconciliacao[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([mes, ano])
  @@index([estado])
}

model ItemReconciliacao {
  id                String            @id @default(cuid())
  reconciliacaoId   String
  reconciliacao     ReconciliacaoMensal @relation(fields: [reconciliacaoId], references: [id], onDelete: Cascade)

  // From PDF
  codigoClientePdf  String            // Client code from PDF (e.g., "00036")
  nomeClientePdf    String            // Client name from PDF
  valorBrutoPdf     Decimal           @db.Decimal(10, 2)
  descontoPdf       Decimal           @db.Decimal(10, 2)
  valorLiquidoPdf   Decimal           @db.Decimal(10, 2)

  // Matched from system (if found)
  clienteId         String?
  cliente           Cliente?          @relation(fields: [clienteId], references: [id])
  vendaId           String?
  venda             Venda?            @relation(fields: [vendaId], references: [id])
  valorSistema      Decimal?          @db.Decimal(10, 2)  // Net value from system

  // Comparison result
  corresponde       Boolean           @default(false)
  tipoDiscrepancia  TipoDiscrepancia?
  diferencaValor    Decimal?          @db.Decimal(10, 2)  // PDF value - System value

  // Resolution
  resolvido         Boolean           @default(false)
  notaResolucao     String?

  createdAt         DateTime          @default(now())

  @@index([reconciliacaoId])
  @@index([clienteId])
  @@index([corresponde])
}
